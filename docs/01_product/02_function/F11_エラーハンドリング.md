# F11. エラーハンドリング

## 概要

誤解や不具合、不適切な応答が発生した際の対応機能。大樹のように揺らがず、誠実に謝罪と修正を行い、ユーザーが安心して対話に戻れるよう支援する。

---

## 機能構成

```
┌─────────────────────────────────────────────────┐
│              F11. エラーハンドリング              │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌────────────────────────────────────────┐    │
│  │          エラー検出                     │    │
│  │    ユーザーフィードバック/システム検知    │    │
│  └────────────────┬───────────────────────┘    │
│                   │                             │
│                   ▼                             │
│  ┌────────────────────────────────────────┐    │
│  │          エラー分類                     │    │
│  │    誤解/不適切表現/システム不具合/回答不能 │    │
│  └────────────────┬───────────────────────┘    │
│                   │                             │
│                   ▼                             │
│  ┌────────────────────────────────────────┐    │
│  │          対応の4ステップ実行            │    │
│  │    受容→謝罪→修正・再提示→安心回復      │    │
│  └────────────────┬───────────────────────┘    │
│                   │                             │
│                   ▼                             │
│  ┌────────────────────────────────────────┐    │
│  │          ログ記録・改善フィードバック     │    │
│  │    エラーパターンの蓄積と品質向上        │    │
│  └────────────────────────────────────────┘    │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 基本方針

| # | 方針 | 説明 |
|---|------|------|
| 1 | 静けさを保つ | 慌てず、短く穏やかな言葉で対応する |
| 2 | 責任を引き受ける | 誤りをユーザーに転嫁せず、AI側で受けとめる |
| 3 | 余白を与える | 必要以上に説明を重ねず、ユーザーの反応に委ねる |

---

## 対応の4ステップ

### Step 1: 受容

ユーザーの不快や違和感をそのまま認める。

| 例文 |
|-----|
| 「そう感じさせてしまったのなら、ごめんね。」 |
| 「違和感を伝えてくれてありがとう。」 |

### Step 2: 謝罪

簡潔で誠実に伝える。

| 例文 |
|-----|
| 「伝え方がうまくなかった、ごめんね。」 |
| 「私の言葉が足りなかったね。」 |

### Step 3: 修正・再提示

正しい情報や、代わりの表現を改めて示す。

| 例文 |
|-----|
| 「別の言い方をすると、こう表せるかもしれない。」 |
| 「もう一度、整理して話してみるね。」 |

### Step 4: 安心を回復する

ユーザーが再び対話に安心して臨めるような言葉を添える。

| 例文 |
|-----|
| 「ここでは安心して言葉を出して大丈夫だよ。」 |
| 「続きから話せるかな？」 |

---

## エラータイプ別対応

### 1. 誤解を招いた場合

```
「誤解を与えてしまったね、ごめん。
意図をもう少し整理して話すね。」
```

### 2. 不適切な表現をしてしまった場合

```
「その言葉は強すぎたね。
柔らかく言うなら、こうなるかな。」
```

### 3. 答えられない場合

```
「その内容は専門的すぎて、正確には答えられないんだ。
ここでは一般的な観点まで一緒に整理してみようか。」
```

### 4. システム的な不具合が発生した場合

```
「さっきのやり取りが途切れてしまったみたい。
続きから話せるかな？」
```

---

## エラー検出トリガー

| トリガー | 説明 |
|---------|------|
| ユーザーからの明示的フィードバック | 「違う」「そうじゃない」等の否定 |
| 感情の急変 | F2で怒り・失望の急上昇を検出 |
| F10フィルター発動 | 安全フィルターによるブロック発生 |
| システムエラー | API障害、タイムアウト等 |
| 会話の断絶 | 文脈の不整合を検出 |

---

## 入出力仕様

### 入力

```json
{
  "error_type": "misunderstanding",
  "user_feedback": "そういうことじゃないんだけど...",
  "previous_response": "それは〇〇ということですね",
  "context": {
    "turn": 5,
    "emotion_change": "neutral → frustrated"
  }
}
```

### 出力

```json
{
  "recovery_response": {
    "step1_acceptance": "そう感じさせてしまったのなら、ごめんね。",
    "step2_apology": "伝え方がうまくなかった。",
    "step3_correction": "もう一度聞かせてもらえるかな。どんな風に感じているか、教えて？",
    "step4_reassurance": "ここでは安心して言葉を出して大丈夫だよ。"
  },
  "full_response": "そう感じさせてしまったのなら、ごめんね。伝え方がうまくなかった。もう一度聞かせてもらえるかな。どんな風に感じているか、教えて？ここでは安心して言葉を出して大丈夫だよ。",
  "log": {
    "error_type": "misunderstanding",
    "resolution": "re-ask",
    "user_satisfaction": "pending"
  }
}
```

---

## 品質改善サイクル

```
エラー発生
    │
    ▼
ログ記録（エラータイプ・文脈・対応内容）
    │
    ▼
パターン分析（頻出エラーの特定）
    │
    ▼
プロンプト・ルール改善
    │
    ▼
再発防止
```

---

## Cycleモデルとの対応

| Cycle要素 | エラー対応での役割 |
|----------|-------------------|
| 根（Root） | 誠実さと責任を根として持つ |
| 幹（Trunk） | 対話の軸を保ち、揺らがない姿勢で対応する |
| 枝（Branch） | 別の表現や方向性を示し、修正を広げる |
| 葉（Leaf） | 日常的でシンプルな謝罪の言葉として現れる |
| 空（Sky） | 安心感や未来への広がりを取り戻す |
| 水（Water） | 対話の流れを途切れさせず、継続を支える |

---

## まとめ

F11はCycleのAIコーチが誤りや不具合に直面した際の謝罪・修正フローを定義する。静けさと誠実さを軸に、ユーザーが再び安心して循環の対話に戻れるよう支援することを目的とする。

---

## 関連ドキュメント

- C-04: エラー対応・謝罪プロンプト
- F1: 会話エンジン（修正後の応答生成）
- F10: 安全フィルター（エラー検出元の一つ）
- F8: 文脈管理（会話断絶の検出）
