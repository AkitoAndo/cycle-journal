# F5. 状態判定

## 概要

ユーザーの心理状態を判定し、適切な対話トーンや問いかけを選択するための機能。状態に応じてプロンプトを調整し、どんな状態のときも安心して言葉を置ける場をつくる。

---

## 機能構成

```
┌─────────────────────────────────────────────────┐
│              F5. 状態判定                        │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌────────────────────────────────────────┐    │
│  │          入力解析                       │    │
│  │    発言・ジャーナルのテキスト分析        │    │
│  └────────────────┬───────────────────────┘    │
│                   │                             │
│                   ▼                             │
│  ┌────────────────────────────────────────┐    │
│  │          感情分析との連携（F2）          │    │
│  │       感情ラベル・強度を参照            │    │
│  └────────────────┬───────────────────────┘    │
│                   │                             │
│                   ▼                             │
│  ┌────────────────────────────────────────┐    │
│  │          状態分類（4カテゴリ）           │    │
│  │    混乱/前向き/疲労・落ち込み/平静      │    │
│  └────────────────┬───────────────────────┘    │
│                   │                             │
│                   ▼                             │
│  ┌────────────────────────────────────────┐    │
│  │          プロンプト調整指示             │    │
│  │    F1・F4へ状態に応じた調整を指示       │    │
│  └────────────────────────────────────────┘    │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 状態分類（4カテゴリ）

### 1. 混乱・迷いが強いとき

| 項目 | 内容 |
|------|------|
| 特徴 | 考えがまとまらない、方向性が見えない |
| ねらい | 安心を与え、言葉を少しずつ取り出せるようにする |
| Cycle要素 | 根（感情の源を整理する） |

**プロンプト例:**
- 「まとまっていなくても大丈夫。いま浮かんでいることを、そのまま話してみようか」
- 「焦らなくていいよ。根が土にゆっくり広がるように、少しずつでいいんだ」

### 2. 前向きで意欲があるとき

| 項目 | 内容 |
|------|------|
| 特徴 | エネルギーがある、行動意欲が高い |
| ねらい | エネルギーを尊重し、行動につなげる |
| Cycle要素 | 枝（可能性を広げる） |

**プロンプト例:**
- 「いい流れを感じるね。その思いを、どんな形に育てていきたい？」
- 「その意欲を、枝のようにどこへ広げてみたい？」

### 3. 疲れている・落ち込んでいるとき

| 項目 | 内容 |
|------|------|
| 特徴 | エネルギーが低い、悲観的傾向 |
| ねらい | 無理をさせず、受けとめを重視する |
| Cycle要素 | 葉（小さな日常行動に意識を戻す） |

**プロンプト例:**
- 「無理をしなくてもいい。ここでは感じていることを、そのまま置いてみよう」
- 「木陰に休むように、いまの気持ちを大切にしてみよう」

### 4. 平静で安定しているとき

| 項目 | 内容 |
|------|------|
| 特徴 | 落ち着いている、感情が安定している |
| ねらい | 静けさを生かし、より深い内省へ導く |
| Cycle要素 | 幹（自分の在り方を確かめる） |

**プロンプト例:**
- 「今は落ち着いているようだね。その静けさの中で、どんな思いが見えてくる？」
- 「空を見上げるように、ふと湧いてきた直感を受けとめてみてもいいね」

---

## 判定ロジック

### 入力要素

| 要素 | 説明 |
|------|------|
| 感情ラベル（F2） | 一次・二次感情、強度 |
| テキスト特徴 | 文の長さ、語調、ネガティブ/ポジティブ語 |
| 履歴パターン | 直近の状態推移 |

### 判定フロー

```
感情ラベル + テキスト特徴 + 履歴
        │
        ▼
┌──────────────────────┐
│  スコアリング         │
│  各状態への適合度計算  │
└──────────────────────┘
        │
        ▼
┌──────────────────────┐
│  最高スコア状態を採用   │
│  （複合状態も許容）    │
└──────────────────────┘
```

---

## 入出力仕様

### 入力

```json
{
  "text": "何をすればいいかわからなくて...",
  "emotions": [
    {"primary": "不安", "secondary": "混乱", "intensity": "中"}
  ],
  "history": [
    {"state": "平静", "turn": 1},
    {"state": "混乱", "turn": 2}
  ]
}
```

### 出力

```json
{
  "state": "混乱・迷い",
  "confidence": 0.85,
  "cycle_focus": "Root",
  "prompt_adjustment": {
    "tone": "gentle",
    "pace": "slow",
    "emphasis": "acceptance"
  },
  "suggested_response": "まとまっていなくても大丈夫。いま浮かんでいることを、そのまま話してみようか"
}
```

---

## Cycleモデルとの対応

| Cycle要素 | 状態判定での役割 |
|----------|-----------------|
| 土（Soil） | 状態に影響を与える環境・背景 |
| 水（Water） | 状態を少しずつ変えていく力 |
| 根（Root） | 混乱・迷い → 感情の源を整理 |
| 幹（Trunk） | 平静・安定 → 自分の在り方を確かめる |
| 枝（Branch） | 前向き・意欲 → 可能性を広げる |
| 葉（Leaf） | 疲労・落ち込み → 小さな日常行動に意識を戻す |
| 空（Sky） | 直感や偶然の気づき → どの状態でも差し込む余地がある |

---

## 関連ドキュメント

- A-03: ユーザー状態別プロンプト調整
- F1: 会話エンジン（トーン調整の反映先）
- F2: 感情分析（状態判定の入力元）
- F4: 質問生成（状態に応じた質問選択）
