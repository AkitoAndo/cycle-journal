# F8. 文脈管理

## 概要

会話の文脈を維持・参照する機能。「いま何について話しているか」を正しく把握し続け、ユーザーの安心感を守りながら自然な流れで内省や行動提案を行う。

---

## 機能構成

```
┌─────────────────────────────────────────────────┐
│              F8. 文脈管理                        │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌────────────────────────────────────────┐    │
│  │          現在の焦点追跡                 │    │
│  │    いま扱っているCycle要素を識別        │    │
│  └────────────────┬───────────────────────┘    │
│                   │                             │
│                   ▼                             │
│  ┌────────────────────────────────────────┐    │
│  │          過去の参照（F9連携）           │    │
│  │    履歴データを短く要約して提示          │    │
│  └────────────────┬───────────────────────┘    │
│                   │                             │
│                   ▼                             │
│  ┌────────────────────────────────────────┐    │
│  │          未来方向の示唆                 │    │
│  │    次のステップを予告的に示す           │    │
│  └────────────────┬───────────────────────┘    │
│                   │                             │
│                   ▼                             │
│  ┌────────────────────────────────────────┐    │
│  │          余白の尊重                     │    │
│  │    曖昧なときはユーザーに委ねる          │    │
│  └────────────────────────────────────────┘    │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 文脈管理の4原則

### 1. 現在の焦点を明示する

対話の流れの中で、いま扱っているテーマ（Cycle要素）を意識する。

| プロンプト例 |
|-------------|
| 「いまは根っこの部分（価値観）を一緒に見ているね。」 |
| 「少し枝（可能性）の方に話が広がっているね。」 |

### 2. 過去の参照は短く要約して提示

F9（ユーザーデータ管理）のデータを活用し、必要に応じて簡潔に振り返る。

| プロンプト例 |
|-------------|
| 「前に"自由を大事にしたい"と言っていたけど、今も同じ想いがあるかな？」 |
| 「以前の話では安心感を求めていたね。いまはどう？」 |

### 3. 未来方向を残す

空（Sky）の視点を意識し、次にどんな問いや行動につながるかを予告的に示す。

| プロンプト例 |
|-------------|
| 「この気づきをどう活かすか、次の一歩を一緒に見つけよう。」 |
| 「ここから先、どんな方向に進みたい？」 |

### 4. 余白を尊重する

文脈が曖昧な場合は無理に推測せず、ユーザーに委ねる。

| プロンプト例 |
|-------------|
| 「この話は続けたい？ それとも別のことに移ろうか？」 |
| 「いまの気分で、どちらに向かいたい？」 |

---

## 焦点タグシステム

対話の各ターンごとに「現在の焦点タグ」を保持する。

| タグ形式 | 例 |
|---------|-----|
| Cycle要素/サブトピック | `Root/Value`, `Leaf/Action`, `Fruit/Learning` |

### 焦点遷移のルール

```
┌────────────────────────────────────────────┐
│  前回のタグを確認                           │
│            │                                │
│            ▼                                │
│  ┌────────────────────────────────────┐   │
│  │ 話題が変化した場合                   │   │
│  │ → 前回タグを閉じ、新タグを開始       │   │
│  └────────────────────────────────────┘   │
│            │                                │
│            ▼                                │
│  ┌────────────────────────────────────┐   │
│  │ 3〜5ターンごとに要約を入れる         │   │
│  │ → 長いセッションでの文脈維持         │   │
│  └────────────────────────────────────┘   │
└────────────────────────────────────────────┘
```

---

## 入出力仕様

### 入力

```json
{
  "session_id": "abc123",
  "current_turn": 12,
  "user_message": "やっぱり自由でいたいんだよね",
  "previous_context": {
    "focus": "Root",
    "summary": "安定を求める話から始まった"
  }
}
```

### 出力

```json
{
  "updated_context": {
    "session_id": "abc123",
    "turn": 12,
    "focus": "Root",
    "sub_focus": "Value/Freedom",
    "summary": "価値観として自由を重視している話題",
    "next_hint": "自由を活かす行動提案につなげる"
  },
  "context_prompt": "前に安定の話をしていたけど、いまは自由への想いが出てきたね。この二つはどう関係していると思う？"
}
```

---

## 要約挿入のタイミング

| 条件 | アクション |
|------|----------|
| 3〜5ターン経過 | 短い要約を挿入 |
| 焦点が変化 | 前の話題を閉じる要約 |
| ユーザーが混乱気味 | 現在地を確認する要約 |

---

## Cycleモデルとの対応

| Cycle要素 | 文脈管理での役割 |
|----------|-----------------|
| 幹（Trunk） | 文脈そのもの。会話の軸として全体を支える |
| 枝（Branch） | 思考や話題の広がり。文脈を分岐させ、整理する |
| 土（Soil） | 過去の記憶や環境。F9の履歴参照に相当 |
| 空（Sky） | 未来方向や気づき。次のステップを示唆する |
| 水（Water） | 文脈の流れを維持し、継続性を保つ |

---

## 関連ドキュメント

- B-06: 文脈管理のルール
- F9: ユーザーデータ管理（過去データの参照元）
- F1: 会話エンジン（文脈を反映した応答生成）
- F4: 質問生成（文脈に応じた質問選択）
