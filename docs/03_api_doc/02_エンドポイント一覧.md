# エンドポイント一覧

## 目次

1. [システム](#システム)
   - [GET /health](#get-health)
2. [認証](#認証)
   - [POST /auth/verify](#post-authverify)
3. [コーチング](#コーチング)
   - [POST /coach](#post-coach)
   - [GET /sessions](#get-sessions)
   - [POST /sessions](#post-sessions)
   - [GET /sessions/{session_id}](#get-sessionssession_id)
4. [タスク](#タスク)
   - [GET /tasks](#get-tasks)
   - [POST /tasks](#post-tasks)
   - [PUT /tasks/{task_id}](#put-taskstask_id)
   - [DELETE /tasks/{task_id}](#delete-taskstask_id)
   - [POST /tasks/{task_id}/reflection](#post-taskstask_idreflection)
5. [ユーザー](#ユーザー)
   - [GET /users/me](#get-usersme)

---

## システム

### GET /health

ヘルスチェックエンドポイント。サービスの稼働状況を確認します。

**認証**: 不要

**リクエスト**
```
GET /health
```

**レスポンス**
```json
{
  "status": "healthy",
  "stage": "dev",
  "timestamp": "2024-01-01T00:00:00.000000"
}
```

---

## 認証

### POST /auth/verify

Apple Identity Tokenを検証し、ユーザー情報を返却します。

**認証**: 不要

**リクエスト**
```json
{
  "identity_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**レスポンス（成功）**
```json
{
  "data": {
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "apple_user_id": "001234.abcdef1234567890.1234",
    "email": "user@privaterelay.appleid.com",
    "is_new_user": false,
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

**エラー**
| コード | 説明 |
|--------|------|
| 400 | identity_tokenが未指定 |
| 401 | トークンが無効または期限切れ |

---

## コーチング

### POST /coach

コーチとの会話を行います。ユーザーのメッセージに対してAIコーチが応答します。

**認証**: 必要

**リクエスト**
```json
{
  "message": "今日は少し疲れている気がする",
  "session_id": "550e8400-e29b-41d4-a716-446655440001",
  "diary_content": "今日は朝から少し疲れを感じていた...",
  "context": {
    "cycle_element": "leaf"
  }
}
```

| フィールド | 型 | 必須 | 説明 |
|------------|-----|------|------|
| message | string | Yes | ユーザーのメッセージ |
| session_id | string | No | 継続する会話のセッションID。省略時は新規セッション |
| diary_content | string | No | 日記の内容（日記を元にセッション開始時のみ） |
| context.cycle_element | string | No | 現在のCycle要素（soil/water/root/trunk/branch/leaf/fruit/sky） |

> **Note**: 日記はローカル保存のため、日記を元にコーチと会話する場合は `diary_content` で日記の内容を直接送信します。

**レスポンス（成功）**
```json
{
  "data": {
    "message": "疲れを感じているんですね。最近、何か変化はありましたか？",
    "session_id": "550e8400-e29b-41d4-a716-446655440001",
    "metadata": {
      "stage": "dev",
      "model": "claude-3-haiku",
      "cycle_element": "leaf",
      "detected_emotion": "fatigue",
      "response_type": "empathetic_inquiry"
    }
  }
}
```

**エラー**
| コード | 説明 |
|--------|------|
| 400 | messageが未指定または空 |
| 401 | 認証エラー |
| 500 | AI応答生成エラー |

---

### GET /sessions

ユーザーの会話セッション一覧を取得します。

**認証**: 必要

**クエリパラメータ**
| パラメータ | 型 | 必須 | 説明 |
|------------|-----|------|------|
| limit | integer | No | 取得件数（デフォルト: 20、最大: 100） |
| offset | integer | No | オフセット（デフォルト: 0） |

**リクエスト**
```
GET /sessions?limit=10&offset=0
```

**レスポンス**
```json
{
  "data": {
    "sessions": [
      {
        "session_id": "550e8400-e29b-41d4-a716-446655440001",
        "title": "今日の振り返り",
        "cycle_element": "leaf",
        "message_count": 5,
        "last_message_at": "2024-01-01T12:00:00Z",
        "created_at": "2024-01-01T10:00:00Z"
      }
    ],
    "total": 15,
    "limit": 10,
    "offset": 0
  }
}
```

---

### POST /sessions

新規会話セッションを作成します。

**認証**: 必要

**リクエスト**
```json
{
  "title": "今日の振り返り",
  "diary_content": "今日は朝から少し疲れを感じていた...",
  "cycle_element": "leaf"
}
```

| フィールド | 型 | 必須 | 説明 |
|------------|-----|------|------|
| title | string | No | セッションのタイトル |
| diary_content | string | No | 日記の内容（日記を元にセッション開始時） |
| cycle_element | string | No | 初期Cycle要素 |

**レスポンス（成功）**
```json
{
  "data": {
    "session_id": "550e8400-e29b-41d4-a716-446655440001",
    "title": "今日の振り返り",
    "cycle_element": "leaf",
    "created_at": "2024-01-01T10:00:00Z"
  }
}
```

---

### GET /sessions/{session_id}

特定のセッションの詳細とメッセージ履歴を取得します。

**認証**: 必要

**パスパラメータ**
| パラメータ | 説明 |
|------------|------|
| session_id | セッションID |

**リクエスト**
```
GET /sessions/550e8400-e29b-41d4-a716-446655440001
```

**レスポンス**
```json
{
  "data": {
    "session_id": "550e8400-e29b-41d4-a716-446655440001",
    "title": "今日の振り返り",
    "cycle_element": "leaf",
    "has_diary_context": true,
    "messages": [
      {
        "message_id": "msg-001",
        "role": "user",
        "content": "今日は少し疲れている気がする",
        "created_at": "2024-01-01T10:00:00Z"
      },
      {
        "message_id": "msg-002",
        "role": "assistant",
        "content": "疲れを感じているんですね。最近、何か変化はありましたか？",
        "metadata": {
          "detected_emotion": "fatigue",
          "response_type": "empathetic_inquiry"
        },
        "created_at": "2024-01-01T10:00:05Z"
      }
    ],
    "created_at": "2024-01-01T10:00:00Z",
    "updated_at": "2024-01-01T10:00:05Z"
  }
}
```

**エラー**
| コード | 説明 |
|--------|------|
| 404 | セッションが存在しない |

---

## タスク

### GET /tasks

ユーザーのタスク一覧を取得します。

**認証**: 必要

**クエリパラメータ**
| パラメータ | 型 | 必須 | 説明 |
|------------|-----|------|------|
| status | string | No | フィルタ（pending/completed） |
| limit | integer | No | 取得件数（デフォルト: 20） |
| offset | integer | No | オフセット（デフォルト: 0） |

**リクエスト**
```
GET /tasks?status=pending&limit=10
```

**レスポンス**
```json
{
  "data": {
    "tasks": [
      {
        "task_id": "550e8400-e29b-41d4-a716-446655440003",
        "title": "5分間深呼吸をする",
        "description": "疲れを感じたときに、5分間の深呼吸で心を落ち着かせましょう",
        "status": "pending",
        "session_id": "550e8400-e29b-41d4-a716-446655440001",
        "cycle_element": "leaf",
        "due_date": "2024-01-02T00:00:00Z",
        "created_at": "2024-01-01T10:00:00Z"
      }
    ],
    "total": 5,
    "limit": 10,
    "offset": 0
  }
}
```

---

### POST /tasks

新規タスクを作成します。

**認証**: 必要

**リクエスト**
```json
{
  "title": "5分間深呼吸をする",
  "description": "疲れを感じたときに、5分間の深呼吸で心を落ち着かせましょう",
  "session_id": "550e8400-e29b-41d4-a716-446655440001",
  "cycle_element": "leaf",
  "due_date": "2024-01-02T00:00:00Z"
}
```

| フィールド | 型 | 必須 | 説明 |
|------------|-----|------|------|
| title | string | Yes | タスクのタイトル |
| description | string | No | タスクの説明 |
| session_id | string | No | 関連するセッションID |
| cycle_element | string | No | 関連するCycle要素 |
| due_date | string | No | 期限（ISO 8601） |

**レスポンス（成功） - 201 Created**
```json
{
  "data": {
    "task_id": "550e8400-e29b-41d4-a716-446655440003",
    "title": "5分間深呼吸をする",
    "description": "疲れを感じたときに、5分間の深呼吸で心を落ち着かせましょう",
    "status": "pending",
    "session_id": "550e8400-e29b-41d4-a716-446655440001",
    "cycle_element": "leaf",
    "due_date": "2024-01-02T00:00:00Z",
    "created_at": "2024-01-01T10:00:00Z"
  }
}
```

---

### PUT /tasks/{task_id}

タスクを更新します。

**認証**: 必要

**パスパラメータ**
| パラメータ | 説明 |
|------------|------|
| task_id | タスクID |

**リクエスト**
```json
{
  "title": "10分間深呼吸をする",
  "status": "completed",
  "completed_at": "2024-01-01T15:00:00Z"
}
```

| フィールド | 型 | 必須 | 説明 |
|------------|-----|------|------|
| title | string | No | タスクのタイトル |
| description | string | No | タスクの説明 |
| status | string | No | ステータス（pending/completed） |
| completed_at | string | No | 完了日時（status=completed時に自動設定） |
| due_date | string | No | 期限 |

**レスポンス（成功）**
```json
{
  "data": {
    "task_id": "550e8400-e29b-41d4-a716-446655440003",
    "title": "10分間深呼吸をする",
    "status": "completed",
    "completed_at": "2024-01-01T15:00:00Z",
    "updated_at": "2024-01-01T15:00:00Z"
  }
}
```

---

### DELETE /tasks/{task_id}

タスクを削除します。

**認証**: 必要

**パスパラメータ**
| パラメータ | 説明 |
|------------|------|
| task_id | タスクID |

**リクエスト**
```
DELETE /tasks/550e8400-e29b-41d4-a716-446655440003
```

**レスポンス（成功） - 204 No Content**

（レスポンスボディなし）

---

### POST /tasks/{task_id}/reflection

タスクのふりかえりを登録します。

**認証**: 必要

**パスパラメータ**
| パラメータ | 説明 |
|------------|------|
| task_id | タスクID |

**リクエスト**
```json
{
  "what_i_did": "朝起きてすぐに5分間深呼吸をした",
  "what_i_noticed": "頭がすっきりして、一日の始まりが穏やかになった",
  "what_i_want_to_try": "明日は10分に伸ばしてみたい",
  "overall_feeling": "良かった"
}
```

| フィールド | 型 | 必須 | 説明 |
|------------|-----|------|------|
| what_i_did | string | Yes | やったこと |
| what_i_noticed | string | Yes | 気づいたこと |
| what_i_want_to_try | string | No | 次にやりたいこと |
| overall_feeling | string | No | 全体の感想 |

**レスポンス（成功） - 201 Created**
```json
{
  "data": {
    "reflection_id": "550e8400-e29b-41d4-a716-446655440004",
    "task_id": "550e8400-e29b-41d4-a716-446655440003",
    "what_i_did": "朝起きてすぐに5分間深呼吸をした",
    "what_i_noticed": "頭がすっきりして、一日の始まりが穏やかになった",
    "what_i_want_to_try": "明日は10分に伸ばしてみたい",
    "overall_feeling": "良かった",
    "created_at": "2024-01-01T20:00:00Z"
  }
}
```

---

## ユーザー

### GET /users/me

認証済みユーザー自身の情報を取得します。

**認証**: 必要

**リクエスト**
```
GET /users/me
```

**レスポンス**
```json
{
  "data": {
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "apple_user_id": "001234.abcdef1234567890.1234",
    "email": "user@privaterelay.appleid.com",
    "display_name": "ユーザー名",
    "settings": {
      "notification_enabled": true,
      "reminder_time": "21:00"
    },
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```
