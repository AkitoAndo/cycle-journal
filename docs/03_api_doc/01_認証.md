# 認証

## 概要

CycleJournal APIはSign in with Appleを使用した認証を採用しています。

---

## 認証フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                        認証フロー                                │
└─────────────────────────────────────────────────────────────────┘

  iOSアプリ                API Gateway              Lambda Authorizer
     │                         │                          │
     │  1. Sign in with Apple  │                          │
     │  ───────────────────>   │                          │
     │  (identityToken取得)    │                          │
     │                         │                          │
     │  2. APIリクエスト        │                          │
     │  Authorization: Bearer  │                          │
     │  ─────────────────────> │                          │
     │                         │                          │
     │                         │  3. トークン検証依頼      │
     │                         │  ─────────────────────>  │
     │                         │                          │
     │                         │                          │  4. Apple公開鍵で
     │                         │                          │     JWT検証
     │                         │                          │
     │                         │  5. 検証結果              │
     │                         │  <─────────────────────  │
     │                         │                          │
     │                         │  6. Lambda実行 or 拒否    │
     │                         │                          │
     │  7. レスポンス           │                          │
     │  <───────────────────── │                          │
     │                         │                          │
```

---

## iOSアプリ側の実装

### Sign in with Appleの実行

```swift
import AuthenticationServices

class AuthManager: NSObject, ASAuthorizationControllerDelegate {
    func signIn() {
        let provider = ASAuthorizationAppleIDProvider()
        let request = provider.createRequest()
        request.requestedScopes = [.fullName, .email]

        let controller = ASAuthorizationController(authorizationRequests: [request])
        controller.delegate = self
        controller.performRequests()
    }

    func authorizationController(
        controller: ASAuthorizationController,
        didCompleteWithAuthorization authorization: ASAuthorization
    ) {
        guard let credential = authorization.credential as? ASAuthorizationAppleIDCredential,
              let identityTokenData = credential.identityToken,
              let identityToken = String(data: identityTokenData, encoding: .utf8) else {
            return
        }

        // identityTokenをAPIリクエストに使用
        saveToken(identityToken)
    }
}
```

### APIリクエストの送信

```swift
func makeAuthenticatedRequest(url: URL) async throws -> Data {
    var request = URLRequest(url: url)
    request.setValue("Bearer \(identityToken)", forHTTPHeaderField: "Authorization")
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")

    let (data, response) = try await URLSession.shared.data(for: request)

    guard let httpResponse = response as? HTTPURLResponse else {
        throw APIError.invalidResponse
    }

    switch httpResponse.statusCode {
    case 200...299:
        return data
    case 401:
        throw APIError.unauthorized
    default:
        throw APIError.serverError(httpResponse.statusCode)
    }
}
```

---

## Lambda Authorizer

### トークン検証の流れ

1. AuthorizationヘッダーからBearerトークンを取得
2. JWTをデコードしてヘッダーからkid（Key ID）を取得
3. Appleの公開鍵エンドポイントから公開鍵を取得
4. 公開鍵を使用してJWT署名を検証
5. issuer、audience、有効期限を検証
6. 検証成功時、IAMポリシーを返却

### Apple公開鍵エンドポイント

```
https://appleid.apple.com/auth/keys
```

### JWT Claims

| Claim | 説明 | 検証内容 |
|-------|------|----------|
| iss | 発行者 | `https://appleid.apple.com` であること |
| aud | 対象者 | アプリのBundle IDであること |
| exp | 有効期限 | 現在時刻より未来であること |
| sub | Subject | Apple User ID（ユーザー識別子として使用） |

---

## エラーレスポンス

### 401 Unauthorized

トークンが無効、期限切れ、または提供されていない場合：

```json
{
  "error": {
    "code": "Unauthorized",
    "message": "Invalid or expired token"
  }
}
```

### 403 Forbidden

トークンは有効だがリソースへのアクセス権がない場合：

```json
{
  "error": {
    "code": "Forbidden",
    "message": "Access denied"
  }
}
```

---

## トークンの検証（サーバー側）

### POST /auth/verify

Apple ID Tokenを検証し、ユーザー情報を返却します。新規ユーザーの場合は自動的に作成されます。

**リクエスト**

```json
{
  "identity_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**レスポンス（成功）**

```json
{
  "data": {
    "user_id": "uuid",
    "apple_user_id": "001234.abcdef...",
    "email": "user@example.com",
    "is_new_user": false,
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

---

## セキュリティ考慮事項

1. **トークンの保存**
   - KeychainにidentityTokenを安全に保存
   - 平文での保存は禁止

2. **トークンの更新**
   - identityTokenは短命（通常10分程度）
   - 必要に応じて再認証を実行

3. **ユーザーの紐付け**
   - Apple User ID（sub claim）でユーザーを一意に識別
   - メールアドレスは変更される可能性があるため識別子として使用しない

4. **リボケーション確認**
   - 定期的にApple User IDの有効性を確認
   - ユーザーがApple IDを削除した場合の対応
