# 認証セットアップガイド

Sign in with Apple を有効にするための設定手順です。

---

## 1. Apple Developer Console の設定

### 1.1 App ID の作成・編集

1. [Apple Developer Console](https://developer.apple.com/account) にログイン

2. **Certificates, Identifiers & Profiles** > **Identifiers** に移動

3. 既存のApp IDを選択、または新規作成
   - **Bundle ID**: `com.cycle.journal`（アプリのBundle IDと一致させる）

4. **Capabilities** セクションで **Sign in with Apple** にチェック

5. **Configure** をクリック
   - **Enable as a primary App ID** を選択
   - **Save** をクリック

6. **Continue** > **Register** で完了

### 1.2 確認事項

- App ID の **Sign in with Apple** が Enabled になっていること
- Bundle ID がアプリと一致していること

---

## 2. Xcode プロジェクトの設定

### 2.1 Signing & Capabilities

1. Xcode でプロジェクトを開く

2. プロジェクトナビゲーターで **CycleJournal** を選択

3. **TARGETS** > **CycleJournal** を選択

4. **Signing & Capabilities** タブを開く

5. **+ Capability** をクリック

6. **Sign in with Apple** を検索して追加

### 2.2 Bundle ID の確認

**General** タブで Bundle Identifier が Apple Developer Console と一致していることを確認:
```
com.cycle.journal
```

### 2.3 チーム設定

**Signing & Capabilities** で:
- **Team**: 開発チームを選択
- **Signing Certificate**: 自動管理または適切な証明書を選択

---

## 3. API デプロイ

### 3.1 初回セットアップ

```bash
# プロジェクトルートに移動
cd /path/to/CycleJournal

# API開発環境をセットアップ
./scripts/setup-api-env.sh
```

### 3.2 Lambda Layer のビルド

```bash
# JWT依存関係をビルド
./scripts/build-lambda-layer.sh
```

### 3.3 デプロイ

```bash
# 開発環境にデプロイ（デフォルト）
./scripts/deploy-api.sh

# ステージとBundle IDを指定してデプロイ
./scripts/deploy-api.sh prod com.cycle.journal
```

### 3.4 デプロイ後の確認

デプロイ完了後、CloudFormation の Outputs から API URL を取得:

```bash
aws cloudformation describe-stacks \
  --stack-name CycleJournalApiStack-dev \
  --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
  --output text
```

---

## 4. iOS アプリの設定

### 4.1 API URL の更新

`CycleJournal/Services/APIClient.swift` を開き、API URLを更新:

```swift
enum APIEnvironment {
    case development
    case production

    var baseURL: String {
        switch self {
        case .development:
            return "https://YOUR_API_ID.execute-api.ap-northeast-1.amazonaws.com/dev"
        case .production:
            return "https://api.cyclejournal.app"
        }
    }
}
```

### 4.2 Bundle ID の確認

`CycleJournal/Stores/AuthStore.swift` の keychainService が正しいことを確認:

```swift
private let keychainService = "com.cycle.journal.auth"
```

---

## 5. 動作確認

### 5.1 シミュレーターでのテスト

1. Xcode でアプリをビルド・実行

2. サインイン画面が表示されることを確認

3. **Sign in with Apple** ボタンをタップ

4. Apple ID でサインイン
   - シミュレーターでは「Password」認証を使用

5. サインイン成功後、メイン画面に遷移することを確認

### 5.2 実機でのテスト

1. 実機を接続

2. Xcode でデバイスを選択してビルド・実行

3. Face ID / Touch ID を使用してサインイン

### 5.3 サインアウトのテスト

1. 設定タブに移動

2. **サインアウト** をタップ

3. 確認ダイアログで **サインアウト** を選択

4. サインイン画面に戻ることを確認

---

## 6. トラブルシューティング

### 問題: Sign in with Apple ボタンが反応しない

**原因**: Capabilityが追加されていない

**解決策**:
1. Xcode で Signing & Capabilities を確認
2. Sign in with Apple が追加されているか確認
3. チーム設定とProvisioning Profileを確認

### 問題: 401 Unauthorized エラー

**原因**: Bundle ID の不一致

**解決策**:
1. iOS アプリの Bundle ID を確認
2. CDK の `apple_bundle_id` パラメータを確認
3. 両者が一致していることを確認して再デプロイ

```bash
./scripts/deploy-api.sh dev com.your.bundle.id
```

### 問題: Token expired エラー

**原因**: Apple Identity Token は短命（約10分）

**解決策**:
- これは正常な動作です
- アプリは自動的に再認証を要求します
- 必要に応じて `authStore.signInWithApple()` を再呼び出し

### 問題: Lambda Authorizer がタイムアウト

**原因**: Apple の公開鍵取得に時間がかかっている

**解決策**:
1. Lambda のタイムアウト設定を確認（10秒以上）
2. VPC設定がある場合、NAT Gateway を確認
3. コールドスタートの影響を考慮

---

## 7. 本番環境へのデプロイ

### 7.1 本番用 App ID の作成

開発環境とは別の App ID を作成することを推奨:
- 開発: `com.cycle.journal.dev`
- 本番: `com.cycle.journal`

### 7.2 本番デプロイ

```bash
./scripts/deploy-api.sh prod com.cycle.journal
```

### 7.3 iOS アプリの環境切り替え

`APIClient.swift` で環境を切り替え:

```swift
// 開発時
private init(environment: APIEnvironment = .development) {

// 本番リリース時
private init(environment: APIEnvironment = .production) {
```

---

## 参考リンク

- [Sign in with Apple - Apple Developer](https://developer.apple.com/sign-in-with-apple/)
- [Implementing User Authentication with Sign in with Apple](https://developer.apple.com/documentation/authenticationservices/implementing_user_authentication_with_sign_in_with_apple)
- [AWS CDK Documentation](https://docs.aws.amazon.com/cdk/v2/guide/home.html)
